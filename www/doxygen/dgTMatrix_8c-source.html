<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Matrix: dgTMatrix.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>dgTMatrix.c</h1><a href="dgTMatrix_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;Rinternals.h&gt;</span>
<a name="l00002"></a>00002 <span class="comment">/* for R_LEN... */</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor">#include "<a class="code" href="dgTMatrix_8h.html">dgTMatrix.h</a>"</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="chm__common_8h.html">chm_common.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="Tsparse_8h.html">Tsparse.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="dtTMatrix_8h.html#a5e44f204f7c1102be03f616393c9523">00009</a> SEXP <a class="code" href="dgTMatrix_8c.html#a5e44f204f7c1102be03f616393c9523">xTMatrix_validate</a>(SEXP x)
<a name="l00010"></a>00010 {
<a name="l00011"></a>00011     <span class="comment">/* Almost everything now in Tsparse_validate ( ./Tsparse.c )</span>
<a name="l00012"></a>00012 <span class="comment">     * *but* the checking of the 'x' slot : */</span>
<a name="l00013"></a>00013     <span class="keywordflow">if</span> (LENGTH(GET_SLOT(x, <a class="code" href="Syms_8h.html#900b6b19a8e80b529c1a26eb9fb6156d">Matrix_iSym</a>)) !=
<a name="l00014"></a>00014         LENGTH(GET_SLOT(x, <a class="code" href="Syms_8h.html#8e6ccf1b89de0c7d61722fd1579eb085">Matrix_xSym</a>)))
<a name="l00015"></a>00015         <span class="keywordflow">return</span> mkString(<a class="code" href="Mutils_8h.html#32a3cf3d9dd914f5aeeca5423c157934">_</a>(<span class="stringliteral">"lengths of slots i and x must match"</span>));
<a name="l00016"></a>00016     <span class="keywordflow">return</span> ScalarLogical(1);
<a name="l00017"></a>00017 }
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00020"></a><a class="code" href="dgTMatrix_8c.html#350b4fde3bdae40f3c20335f350a7e05">00020</a> <a class="code" href="dgTMatrix_8c.html#350b4fde3bdae40f3c20335f350a7e05">d_insert_triplets_in_array</a>(<span class="keywordtype">int</span> m, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> nnz,
<a name="l00021"></a>00021                            <span class="keyword">const</span> <span class="keywordtype">int</span> xi[], <span class="keyword">const</span> <span class="keywordtype">int</span> xj[],
<a name="l00022"></a>00022                            <span class="keyword">const</span> <span class="keywordtype">double</span> xx[], <span class="keywordtype">double</span> vx[])
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024     <span class="keywordtype">int</span> i;
<a name="l00025"></a>00025     memset(vx, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * m * n);
<a name="l00026"></a>00026     <span class="keywordflow">for</span> (i = 0; i &lt; nnz; i++) {
<a name="l00027"></a>00027         vx[xi[i] + xj[i] * m] += xx[i]; <span class="comment">/* allow redundant entries in x */</span>
<a name="l00028"></a>00028     }
<a name="l00029"></a>00029 }
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00032"></a><a class="code" href="dgTMatrix_8c.html#190ec633aa4dac6fcccaf138c6b1d072">00032</a> <a class="code" href="dgTMatrix_8c.html#190ec633aa4dac6fcccaf138c6b1d072">l_insert_triplets_in_array</a>(<span class="keywordtype">int</span> m, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> nnz,
<a name="l00033"></a>00033                            <span class="keyword">const</span> <span class="keywordtype">int</span> xi[], <span class="keyword">const</span> <span class="keywordtype">int</span> xj[],
<a name="l00034"></a>00034                            <span class="keyword">const</span> <span class="keywordtype">int</span> xx[], <span class="keywordtype">int</span> vx[])
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036     <span class="keywordtype">int</span> i;
<a name="l00037"></a>00037     memset(vx, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * m * n);
<a name="l00038"></a>00038     <span class="keywordflow">for</span> (i = 0; i &lt; nnz; i++) {
<a name="l00039"></a>00039         vx[xi[i] + xj[i] * m] += xx[i]; <span class="comment">/* allow redundant entries in x */</span>
<a name="l00040"></a>00040     }
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="dgTMatrix_8c.html#1fb3f8da8caae4a3afce72693042a577">00043</a> <span class="preprocessor">#define MAKE_gTMatrix_to_geMatrix(_t1_, _SEXPTYPE_, _SEXP_)             \</span>
<a name="l00044"></a>00044 <span class="preprocessor">SEXP _t1_ ## gTMatrix_to_ ## _t1_ ## geMatrix(SEXP x)                   \</span>
<a name="l00045"></a>00045 <span class="preprocessor">{                                                                       \</span>
<a name="l00046"></a>00046 <span class="preprocessor">    SEXP dd = GET_SLOT(x, Matrix_DimSym),                               \</span>
<a name="l00047"></a>00047 <span class="preprocessor">        islot = GET_SLOT(x, Matrix_iSym),                               \</span>
<a name="l00048"></a>00048 <span class="preprocessor">        ans = PROTECT(NEW_OBJECT(MAKE_CLASS(#_t1_ "geMatrix")));        \</span>
<a name="l00049"></a>00049 <span class="preprocessor">                                                                        \</span>
<a name="l00050"></a>00050 <span class="preprocessor">    int *dims = INTEGER(dd),                                            \</span>
<a name="l00051"></a>00051 <span class="preprocessor">        m = dims[0],                                                    \</span>
<a name="l00052"></a>00052 <span class="preprocessor">        n = dims[1];                                                    \</span>
<a name="l00053"></a>00053 <span class="preprocessor">    double len = m * (double)n;                                         \</span>
<a name="l00054"></a>00054 <span class="preprocessor">                                                                        \</span>
<a name="l00055"></a>00055 <span class="preprocessor">    if (len &gt; R_LEN_T_MAX)                                              \</span>
<a name="l00056"></a>00056 <span class="preprocessor">        error(_("Cannot coerce to too large *geMatrix with %.0f entries"), \</span>
<a name="l00057"></a>00057 <span class="preprocessor">              len);                                                     \</span>
<a name="l00058"></a>00058 <span class="preprocessor">                                                                        \</span>
<a name="l00059"></a>00059 <span class="preprocessor">    SET_SLOT(ans, Matrix_factorSym, allocVector(VECSXP, 0));            \</span>
<a name="l00060"></a>00060 <span class="preprocessor">    SET_SLOT(ans, Matrix_DimSym, duplicate(dd));                        \</span>
<a name="l00061"></a>00061 <span class="preprocessor">    SET_DimNames(ans, x);                                               \</span>
<a name="l00062"></a>00062 <span class="preprocessor">    SET_SLOT(ans, Matrix_xSym, allocVector(_SEXPTYPE_, (R_len_t)len));  \</span>
<a name="l00063"></a>00063 <span class="preprocessor">    _t1_ ## _insert_triplets_in_array(m, n, length(islot),              \</span>
<a name="l00064"></a>00064 <span class="preprocessor">                                      INTEGER(islot),                   \</span>
<a name="l00065"></a>00065 <span class="preprocessor">                                      INTEGER(GET_SLOT(x, Matrix_jSym)),\</span>
<a name="l00066"></a>00066 <span class="preprocessor">                                      _SEXP_(GET_SLOT(x, Matrix_xSym)), \</span>
<a name="l00067"></a>00067 <span class="preprocessor">                                      _SEXP_(GET_SLOT(ans, Matrix_xSym))); \</span>
<a name="l00068"></a>00068 <span class="preprocessor">    UNPROTECT(1);                                                       \</span>
<a name="l00069"></a>00069 <span class="preprocessor">    return ans;                                                         \</span>
<a name="l00070"></a>00070 <span class="preprocessor">}</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a>00072 <a class="code" href="dgTMatrix_8c.html#1fb3f8da8caae4a3afce72693042a577">MAKE_gTMatrix_to_geMatrix</a>(d, REALSXP, REAL)
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <a class="code" href="dgTMatrix_8c.html#1fb3f8da8caae4a3afce72693042a577">MAKE_gTMatrix_to_geMatrix</a>(l, LGLSXP, LOGICAL)
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor">#undef MAKE_gTMatrix_to_geMatrix</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="preprocessor">#define MAKE_gTMatrix_to_matrix(_t1_, _SEXPTYPE_, _SEXP_)               \</span>
<a name="l00079"></a>00079 <span class="preprocessor">SEXP _t1_ ## gTMatrix_to_matrix(SEXP x)                                 \</span>
<a name="l00080"></a>00080 <span class="preprocessor">{                                                                       \</span>
<a name="l00081"></a>00081 <span class="preprocessor">    SEXP dd = GET_SLOT(x, Matrix_DimSym),                               \</span>
<a name="l00082"></a>00082 <span class="preprocessor">        dn = GET_SLOT(x, Matrix_DimNamesSym),                           \</span>
<a name="l00083"></a>00083 <span class="preprocessor">        islot = GET_SLOT(x, Matrix_iSym);                               \</span>
<a name="l00084"></a>00084 <span class="preprocessor">    int m = INTEGER(dd)[0],                                             \</span>
<a name="l00085"></a>00085 <span class="preprocessor">        n = INTEGER(dd)[1];                                             \</span>
<a name="l00086"></a>00086 <span class="preprocessor">    SEXP ans = PROTECT(allocMatrix(_SEXPTYPE_, m, n));                  \</span>
<a name="l00087"></a>00087 <span class="preprocessor">    if(VECTOR_ELT(dn, 0) != R_NilValue || VECTOR_ELT(dn, 1) != R_NilValue) \</span>
<a name="l00088"></a>00088 <span class="preprocessor">        </span><span class="comment">/* matrix() with non-trivial dimnames */</span>                        \
<a name="l00089"></a>00089         setAttrib(ans, R_DimNamesSymbol, duplicate(dn));                \
<a name="l00090"></a>00090     _t1_ ## _insert_triplets_in_array(m, n, length(islot),              \
<a name="l00091"></a>00091                                       INTEGER(islot),                   \
<a name="l00092"></a>00092                                       INTEGER(GET_SLOT(x, Matrix_jSym)),\
<a name="l00093"></a>00093                                       _SEXP_(GET_SLOT(x, Matrix_xSym)), \
<a name="l00094"></a>00094                                       _SEXP_(ans));                     \
<a name="l00095"></a>00095     UNPROTECT(1);                                                       \
<a name="l00096"></a>00096     return ans;                                                         \
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <a class="code" href="dgTMatrix_8c.html#0fa894c796c226504a70cfdd93a02ffb">MAKE_gTMatrix_to_matrix</a>(d, REALSXP, REAL)
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 MAKE_gTMatrix_to_matrix(l, LGLSXP, LOGICAL)
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="preprocessor">#undef MAKE_gTMatrix_to_matrix</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="preprocessor">#ifdef _valid_only_for_old_graph_package</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>SEXP graphNEL_as_dgTMatrix(SEXP x, SEXP symmetric)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109     <span class="keywordtype">int</span> sym = asLogical(symmetric);
<a name="l00110"></a>00110     SEXP nodes = GET_SLOT(x, install(<span class="stringliteral">"nodes"</span>)),
<a name="l00111"></a>00111         edgeL = GET_SLOT(x, install(<span class="stringliteral">"edgeL"</span>)),
<a name="l00112"></a>00112         ans = PROTECT(NEW_OBJECT(MAKE_CLASS(sym
<a name="l00113"></a>00113                                             ? <span class="stringliteral">"dsTMatrix"</span>
<a name="l00114"></a>00114                                             : <span class="stringliteral">"dgTMatrix"</span>)));
<a name="l00115"></a>00115     <span class="keywordtype">int</span> *ii, *jj, *dims, i, j, nnd = LENGTH(nodes), pos, totl;
<a name="l00116"></a>00116     <span class="keywordtype">double</span> *xx;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     totl = 0;
<a name="l00119"></a>00119     <span class="keywordflow">for</span> (i = 0; i &lt; nnd; i++)
<a name="l00120"></a>00120         totl += LENGTH(<a class="code" href="Mutils_8c.html#c400cec966c098c329850d1e2878e563" title="Return the element of a given name from a named list.">Matrix_getElement</a>(VECTOR_ELT(edgeL, i), <span class="stringliteral">"edges"</span>));
<a name="l00121"></a>00121     dims = INTEGER(<a class="code" href="Mutils_8h.html#f7f59236ca18ab52131cf71f4a7b0786" title="Allocate an SEXP of given type and length, assign it as slot nm in the object, and...">ALLOC_SLOT</a>(ans, <a class="code" href="Syms_8h.html#2b91d011a529c5665e032a6565275374">Matrix_DimSym</a>, INTSXP, 2));
<a name="l00122"></a>00122     dims[0] = dims[1] = nnd;
<a name="l00123"></a>00123     <span class="keywordflow">if</span> (isString(nodes)) {
<a name="l00124"></a>00124         SEXP dnms = <a class="code" href="Mutils_8h.html#f7f59236ca18ab52131cf71f4a7b0786" title="Allocate an SEXP of given type and length, assign it as slot nm in the object, and...">ALLOC_SLOT</a>(ans, <a class="code" href="Syms_8h.html#93d8b8a3cd9c897599b3e2d996821a0b">Matrix_DimNamesSym</a>, VECSXP, 2);
<a name="l00125"></a>00125         SET_VECTOR_ELT(dnms, 0, duplicate(nodes));
<a name="l00126"></a>00126         SET_VECTOR_ELT(dnms, 1, duplicate(nodes));
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128     ii = <a class="code" href="Mutils_8h.html#679ceea530c97713d6abdb619e70a6b9">Alloca</a>(totl, <span class="keywordtype">int</span>);
<a name="l00129"></a>00129     jj = <a class="code" href="Mutils_8h.html#679ceea530c97713d6abdb619e70a6b9">Alloca</a>(totl, <span class="keywordtype">int</span>);
<a name="l00130"></a>00130     xx = <a class="code" href="Mutils_8h.html#679ceea530c97713d6abdb619e70a6b9">Alloca</a>(totl, <span class="keywordtype">double</span>);
<a name="l00131"></a>00131     R_CheckStack();
<a name="l00132"></a>00132     pos = 0;
<a name="l00133"></a>00133     <span class="keywordflow">for</span> (i = 0; i &lt; nnd; i++) {
<a name="l00134"></a>00134         SEXP edg = VECTOR_ELT(edgeL, i);
<a name="l00135"></a>00135         SEXP edges = <a class="code" href="Mutils_8c.html#c400cec966c098c329850d1e2878e563" title="Return the element of a given name from a named list.">Matrix_getElement</a>(edg, <span class="stringliteral">"edges"</span>),
<a name="l00136"></a>00136             weights = <a class="code" href="Mutils_8c.html#c400cec966c098c329850d1e2878e563" title="Return the element of a given name from a named list.">Matrix_getElement</a>(edg, <span class="stringliteral">"weights"</span>);
<a name="l00137"></a>00137         <span class="keywordtype">int</span> *edgs = INTEGER(PROTECT(coerceVector(edges, INTSXP))),
<a name="l00138"></a>00138             nedg = LENGTH(edges);
<a name="l00139"></a>00139         <span class="keywordtype">double</span> *wts = REAL(weights);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="keywordflow">for</span> (j = 0; j &lt; nedg; j++) {
<a name="l00142"></a>00142             <span class="keywordtype">int</span> j1 = edgs[j] - 1;
<a name="l00143"></a>00143                         <span class="comment">/* symmetric case stores upper triangle only */</span>
<a name="l00144"></a>00144             <span class="keywordflow">if</span> ((!sym) || i &lt;= j1) {
<a name="l00145"></a>00145                 ii[pos] = i;
<a name="l00146"></a>00146                 jj[pos] = j1;
<a name="l00147"></a>00147                 xx[pos] = wts[j];
<a name="l00148"></a>00148                 pos++;
<a name="l00149"></a>00149             }
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151         UNPROTECT(1);
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     Memcpy(INTEGER(<a class="code" href="Mutils_8h.html#f7f59236ca18ab52131cf71f4a7b0786" title="Allocate an SEXP of given type and length, assign it as slot nm in the object, and...">ALLOC_SLOT</a>(ans, <a class="code" href="Syms_8h.html#900b6b19a8e80b529c1a26eb9fb6156d">Matrix_iSym</a>, INTSXP, pos)), ii, pos);
<a name="l00154"></a>00154     Memcpy(INTEGER(<a class="code" href="Mutils_8h.html#f7f59236ca18ab52131cf71f4a7b0786" title="Allocate an SEXP of given type and length, assign it as slot nm in the object, and...">ALLOC_SLOT</a>(ans, <a class="code" href="Syms_8h.html#92da52e94414e4e2c04f11a6dce844d7">Matrix_jSym</a>, INTSXP, pos)), jj, pos);
<a name="l00155"></a>00155     Memcpy(REAL(<a class="code" href="Mutils_8h.html#f7f59236ca18ab52131cf71f4a7b0786" title="Allocate an SEXP of given type and length, assign it as slot nm in the object, and...">ALLOC_SLOT</a>(ans, <a class="code" href="Syms_8h.html#8e6ccf1b89de0c7d61722fd1579eb085">Matrix_xSym</a>, REALSXP, pos)), xx, pos);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     UNPROTECT(1);
<a name="l00158"></a>00158     <span class="keywordflow">return</span> ans;
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 <span class="preprocessor">#endif</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Sep 12 17:21:57 2008 for Matrix by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
